    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.pull_request.head.ref'],
                [key: 'sha', value: '$.pull_request.head.sha']
            ],
            causeString: 'Triggered by GitHub pull request',
            domain: credentials('ngrok_domain'),
            token: credentials('token'),
            printContributedVariables: true,
            printPostContent: true
        )
    }
pipeline {
    agent any
    
    tools {
        maven 'maven_3.6.3'
        jdk 'jdk_8'
    }

    environment {
        DOCKER_IMAGE = 'admin_user_service'
        DOCKER_REGISTRY = 'bebe97'
        DOCKER = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'development',
                credentialsId: 'github_credentials',
                url: 'https://github.com/SebestyenBenedek/table_reservation_backend.git'
            }
        }

        stage('Build') {
            steps {
                script {
                    try {
                        dir('admin_user_service') {
                            sh 'chmod +x ./increment_version.sh'
                            def newVersion = sh(script: './increment_version.sh', returnStdout: true).trim()
                            env.VERSION = newVersion
                            sh "docker build -t ${env.DOCKER}:${env.VERSION} -f admin_user_service.Dockerfile ."
                        }
                    } catch (Exception e) {
                        sh 'echo "Failed to build Docker image: ${e.message}"'
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }

        stage('Commit Version Update') {
            steps {
                script {
                    sh """
                        git config user.name 'SebestyenBenedek'
                        git config user.email 'sebi.bebe@gmail.com'
                        git add version.txt
                        git commit -m "Update version to ${env.VERSION}"
                        git push origin development
                    """
                    withCredentials([usernamePassword(credentialsId: 'github_credentials_with_token', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_TOKEN')]) {
                        sh "git push https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/SebestyenBenedek/table_reservation_backend.git development"
                    }
                }
            }
        }


        stage('Authentication') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_hub_credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh 'echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    try {
                        dir('admin_user_service') {
                            sh 'mvn test'
                            sh 'echo "tests ran successfully"'
                        }
                    } catch (Exception e) {
                        sh 'echo "Failed to build Docker image: ${e.message}"'
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }

        stage('Merge-main-branch-to-feature-branch') {
            steps {
                script {
                    try {
                        sh 'git checkout development'
                        sh 'git pull origin development'

                        def ref = env.CHANGE_BRANCH ?: 'feature/add_docker_and_jenkins_to_admin_user_service'
                        sh "git fetch origin ${ref}"
                        sh "git checkout ${ref}"
                        sh "git merge development"
                    } catch (Exception e) {
                        sh 'echo "Failed to build Docker image: ${e.message}"'
                        currentBuild.result = 'FAILURE'
                    }

                }
            }
        }

        stage('Test-merged-feature-branch') {
            steps {
                script {
                        try {
                            dir('admin_user_service') {
                                sh 'mvn test'
                                sh 'echo "tests ran successfully"'
                            }
                        } catch (Exception e) {
                            sh 'echo "Failed to build Docker image: ${e.message}"'
                            currentBuild.result = 'FAILURE'
                        }
                }
            }
        }

        stage('Manual-merge-approval') {
            steps {
                script {
                    def userInput = input(id: 'userInput', message: 'Please review and approve the merge:', parameters: [
                        [$class: 'BooleanParameterDefinition', defaultValue: false, description: '', name: 'approve']
                    ])
                    if (userInput == false) {
                        error('Merge not approved. Aborting.')
                    }
                }
            }
        }

        stage('Merge-feature-branch-to-main') {
            steps {
                script {
                    try {
                        sh 'git checkout development'
                        sh 'git pull origin development'

                        def ref = env.CHANGE_BRANCH ?: 'feature/add_docker_and_jenkins_to_admin_user_service'
                        sh "git fetch origin ${ref}"
                        sh "git checkout ${ref}"
                        sh "git merge development"

                        withCredentials([usernamePassword(credentialsId: 'github_credentials_with_token', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_TOKEN')]) {
                            sh "git push https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/SebestyenBenedek/table_reservation_backend.git ${ref}"
                        }
                    } catch (Exception e) {
                        sh 'echo "Failed to build Docker image: ${e.message}"'
                        currentBuild.result = 'FAILURE'
                    }

                }
            }
        }

        stage('Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker_hub_credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        try {
                            sh '''
                                echo ${DOCKER_PASSWORD} | docker login --username ${DOCKER_USERNAME} --password-stdin https://registry.hub.docker.com
                                docker push "${env.DOCKER}:${env.VERSION}"
                            '''
                        } catch (Exception e) {
                            sh 'echo "Failed to build Docker image: ${e.message}"'
                            currentBuild.result = 'FAILURE'
                        }
                    }
                }
            }
        }
    }
}
